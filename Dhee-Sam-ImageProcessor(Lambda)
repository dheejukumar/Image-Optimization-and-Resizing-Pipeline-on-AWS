import os
import io
import logging
from PIL import Image, ImageOps, ImageDraw, ImageFont
import boto3

logger = logging.getLogger()
logger.setLevel(logging.INFO)

s3 = boto3.client("s3")

# ----- CONFIGS -----
TARGETS = {
    "large": 1920,
    "medium": 1280,
    "small": 720
}

WATERMARK_TEXT = os.environ.get("WATERMARK", "")  # optional
OUTPUT_BUCKET = os.environ.get("OUTPUT_BUCKET")

# --------------------


def add_watermark(image: Image.Image, text: str):
    drawable = ImageDraw.Draw(image)
    font = ImageFont.load_default()

    w, h = image.size
    text_w, text_h = drawable.textsize(text, font=font)
    margin = 10

    pos = (w - text_w - margin, h - text_h - margin)
    drawable.text(pos, text, fill=(255, 255, 255, 128), font=font)
    return image


def compress_image(img: Image.Image, fmt: str, quality: int = 85) -> bytes:
    buf = io.BytesIO()
    save_kwargs = {}

    if fmt.lower() in ['jpeg', 'jpg']:
        save_kwargs['format'] = 'JPEG'
        save_kwargs['optimize'] = True
        save_kwargs['quality'] = quality
        save_kwargs['progressive'] = True

    elif fmt.lower() == 'webp':
        save_kwargs['format'] = 'WEBP'
        save_kwargs['quality'] = quality
        save_kwargs['method'] = 6

    else:
        save_kwargs['format'] = fmt.upper()

    img.save(buf, **save_kwargs)
    buf.seek(0)
    return buf.read()


def resize_and_process(image_bytes: bytes, key: str):
    with Image.open(io.BytesIO(image_bytes)) as img:
        # fix EXIF rotation
        img = ImageOps.exif_transpose(img)
        orig_format = img.format or "JPEG"
        orig_size = len(image_bytes)

        for label, target_w in TARGETS.items():
            w, h = img.size

            # maintain aspect ratio
            if w <= target_w:
                resized = img.copy()
            else:
                new_h = int(target_w * h / w)
                resized = img.resize((target_w, new_h), Image.LANCZOS)

            # optional watermark
            if WATERMARK_TEXT:
                resized = add_watermark(resized, WATERMARK_TEXT)

            # output format
            out_format = os.environ.get("OUT_FORMAT", orig_format)
            quality = int(os.environ.get("QUALITY", "85"))

            data = compress_image(resized, out_format, quality=quality)

            # new file path
            base_name = key.rsplit("/", 1)[-1].rsplit(".", 1)[0]
            out_key = f"{label}/{base_name}.{out_format.lower()}"

            s3.put_object(
                Bucket=OUTPUT_BUCKET,
                Key=out_key,
                Body=data,
                ContentType=f"image/{out_format.lower()}"
            )

            logger.info(
                f"Wrote {out_key} ({len(data)} bytes) from original {orig_size} bytes"
            )


def lambda_handler(event, context):
    logger.info("Event: %s", event)

    for record in event.get("Records", []):
        s3_info = record["s3"]
        bucket = s3_info["bucket"]["name"]
        key = s3_info["object"]["key"]

        # download original file
        obj = s3.get_object(Bucket=bucket, Key=key)
        body = obj["Body"].read()

        # process
        resize_and_process(body, key)

    return {"status": "ok"}
